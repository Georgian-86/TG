# TeachGenie.ai - Cost-Optimized Cloud Architecture

## üéØ Executive Summary

This document outlines a **phased, cost-optimized deployment strategy** that starts lean (~$50-100/month) and scales elastically based on actual usage, ensuring you don't over-provision resources while maintaining production-grade functionality.

**Core Philosophy**: "Pay for what you use, scale when you need to"

---

## üìä Architecture Strategy Overview

### Phase 1: MVP Launch (0-100 users) - **~$80/month**
### Phase 2: Growth (100-1000 users) - **~$350/month**  
### Phase 3: Scale (1000+ users) - **~$1000+/month**

---

## üèóÔ∏è Cost-Optimized Architecture (Phase 1: MVP)

```mermaid
graph TB
    subgraph "Static Assets - $0/mo"
        CF[Cloudflare CDN FREE]
        Vercel[Vercel Next.js FREE tier]
    end
    
    subgraph "Compute - $25/mo"
        Railway[Railway.app<br/>Backend API + Redis<br/>$5/mo]
        Supabase[Supabase<br/>PostgreSQL + Auth<br/>FREE tier]
    end
    
    subgraph "Storage - $5/mo"
        R2[Cloudflare R2<br/>10GB free then $0.015/GB]
    end
    
    subgraph "External - $50/mo"
        OpenAI[OpenAI API<br/>Pay per use]
        Email[Resend.com<br/>3k emails FREE]
    end
    
    Vercel --> CF
    Vercel --> Railway
    Railway --> Supabase
    Railway --> R2
    Railway --> OpenAI
    Railway --> Email
```

**Total MVP Cost: ~$80/month** (mostly OpenAI API usage)

---

## üí° Cost Optimization Strategies

### 1. **Serverless-First Approach** ‚ö°

**Why**: Pay only for actual compute time, not idle resources.

**Recommended Stack**:
```
Frontend: Vercel (Next.js) - FREE tier ‚Üí $20/mo at scale
Backend API: Railway.app or Render.com - $5-25/mo
Database: Supabase (managed PostgreSQL) - FREE ‚Üí $25/mo
File Storage: Cloudflare R2 - $0.015/GB (10x cheaper than S3)
CDN: Cloudflare - FREE tier
Email: Resend.com - 3k emails/mo FREE
```

**Cost Comparison**:

| Service | AWS (Traditional) | Serverless Alternative | Monthly Savings |
|---------|------------------|------------------------|-----------------|
| **Compute** | EC2 t3.small ($17) | Railway ($5) | **$12** |
| **Database** | RDS t3.micro ($15) | Supabase FREE | **$15** |
| **Storage** | S3 Standard ($0.023/GB) | R2 ($0.015/GB) | **35% cheaper** |
| **CDN** | CloudFront ($0.085/GB) | Cloudflare FREE | **100% savings** |
| **Total** | ~$50/mo base | ~$5/mo base | **$45/mo** |

---

### 2. **Database Optimization** üóÑÔ∏è

#### Option A: Supabase (Recommended for MVP)
```yaml
Tier: FREE (up to 500MB database)
Features:
  - PostgreSQL 15
  - Built-in authentication
  - Row Level Security
  - Auto-generated REST API
  - Realtime subscriptions
  - 1GB file storage

Cost: $0/mo ‚Üí $25/mo (Pro tier at scale)
```

#### Option B: PlanetScale (MySQL alternative)
```yaml
Tier: FREE (5GB storage, 1B row reads/mo)
Features:
  - Serverless MySQL
  - Non-blocking schema changes
  - Auto-scaling
  - Branch deployments

Cost: $0/mo ‚Üí $29/mo (Scaler tier)
```

#### Option C: AWS RDS with Reserved Instances (Scale phase)
- Use **db.t4g.micro** (ARM-based, 20% cheaper)
- Purchase 1-year Reserved Instance (40% discount)
- Enable auto-pause for Aurora Serverless v2 during off-hours

**Optimization Techniques**:
```python
# 1. Connection pooling (reduce DB connections)
from sqlalchemy.pool import QueuePool

engine = create_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=5,        # Small pool for MVP
    max_overflow=10,
    pool_pre_ping=True  # Check connection health
)

# 2. Query optimization with caching
from functools import lru_cache

@lru_cache(maxsize=100)
def get_lesson_template(level: str):
    # Cache frequently accessed data
    return db.query(LessonTemplate).filter_by(level=level).first()

# 3. Use database indexes
# migrations/versions/xxx_add_indexes.py
def upgrade():
    op.create_index('idx_lessons_user_created', 'lessons', 
                    ['user_id', 'created_at'])
    op.create_index('idx_lessons_status', 'lessons', ['status'])
```

---

### 3. **Smart Compute Scaling** üìà

#### Recommended Platform: **Railway.app**

**Why Railway**:
- Automatic scaling based on actual usage
- Built-in Redis (no separate ElastiCache costs)
- GitHub integration (auto-deploy)
- FREE $5 credit/month
- Pay only for resources used (no idle costs)

**Configuration**:
```yaml
# railway.json
{
  "build": {
    "builder": "NIXPACKS"
  },
  "deploy": {
    "numReplicas": 1,
    "sleepAfterInactivity": "1h",  # Scale to zero during inactivity
    "restartPolicyType": "ON_FAILURE",
    "healthcheckPath": "/health",
    "healthcheckTimeout": 100
  },
  "resources": {
    "cpu": "0.5",      # Start small, auto-scale up
    "memory": "512MB"  # Sufficient for MVP
  }
}
```

**Cost**: $5-25/month depending on usage

#### Alternative: **Render.com**
- Similar pricing model
- Better for background workers (Celery)
- Native Redis integration

---

### 4. **File Storage Strategy** üì¶

#### Option A: Cloudflare R2 (Recommended)

**Why R2**:
- **Zero egress fees** (huge savings vs S3)
- S3-compatible API (easy migration)
- 10GB free storage
- $0.015/GB storage ($1.50 for 100GB)

**Implementation**:
```python
# services/storage.py
import boto3
from botocore.config import Config

# R2 is S3-compatible
s3_client = boto3.client(
    's3',
    endpoint_url=f'https://{ACCOUNT_ID}.r2.cloudflarestorage.com',
    aws_access_key_id=R2_ACCESS_KEY,
    aws_secret_access_key=R2_SECRET_KEY,
    config=Config(signature_version='s3v4')
)

def upload_file(file_path: str, key: str):
    with open(file_path, 'rb') as f:
        s3_client.upload_fileobj(
            f, 
            BUCKET_NAME, 
            key,
            ExtraArgs={'ContentType': 'application/pdf'}
        )
    
    # Generate signed URL (expires in 1 hour)
    url = s3_client.generate_presigned_url(
        'get_object',
        Params={'Bucket': BUCKET_NAME, 'Key': key},
        ExpiresIn=3600
    )
    return url
```

**Lifecycle Policy** (Cost savings):
```python
# Delete files older than 30 days (for free tier users)
lifecycle_config = {
    'Rules': [{
        'Id': 'DeleteOldFiles',
        'Status': 'Enabled',
        'Filter': {'Prefix': 'free-tier/'},
        'Expiration': {'Days': 30}
    }]
}
```

**Monthly Cost Estimate**:
- 100 users √ó 5 lessons √ó 2MB (PPT+PDF) = 1GB storage
- Cost: **$0.015/GB = $0.015/month** üòÆ

---

### 5. **CDN & Caching Strategy** üöÄ

#### Cloudflare (FREE Plan)

**Features**:
- Unlimited bandwidth
- DDoS protection
- SSL/TLS certificates
- Page caching
- Image optimization

**Cache Configuration**:
```javascript
// next.config.js
module.exports = {
  async headers() {
    return [
      {
        source: '/:all*(svg|jpg|png)',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, max-age=31536000, immutable',
          },
        ],
      },
      {
        source: '/api/:path*',
        headers: [
          {
            key: 'Cache-Control',
            value: 'public, s-maxage=60, stale-while-revalidate=120',
          },
        ],
      },
    ]
  },
}
```

**Redis Caching** (Railway built-in):
```python
# Cache lesson plans for 1 hour
import redis

redis_client = redis.from_url(REDIS_URL)

def get_lesson(lesson_id: str):
    # Try cache first
    cached = redis_client.get(f"lesson:{lesson_id}")
    if cached:
        return json.loads(cached)
    
    # Fetch from DB
    lesson = db.query(Lesson).get(lesson_id)
    
    # Cache for 1 hour
    redis_client.setex(
        f"lesson:{lesson_id}",
        3600,
        json.dumps(lesson.dict())
    )
    return lesson
```

**Cost**: FREE with Cloudflare + Railway Redis

---

### 6. **OpenAI API Cost Optimization** üí∞

**Current Issue**: OpenAI is likely your biggest cost driver.

**Optimization Strategies**:

#### A. **Use GPT-4o-mini Instead of GPT-4**
```python
# Cost comparison per 1M tokens:
# GPT-4: $30 (input) / $60 (output)
# GPT-4o-mini: $0.15 (input) / $0.60 (output)
# Savings: 99% cheaper!

response = client.chat.completions.create(
    model="gpt-4o-mini",  # Already using this ‚úÖ
    messages=[...],
    max_tokens=500,  # Set reasonable limits
    temperature=0.3   # Lower = more deterministic = fewer retries
)
```

#### B. **Implement Token Budgets**
```python
# Estimate tokens before API call
import tiktoken

def estimate_cost(prompt: str, model: str = "gpt-4o-mini"):
    encoding = tiktoken.encoding_for_model(model)
    tokens = len(encoding.encode(prompt))
    
    # GPT-4o-mini pricing
    cost_per_1k_input = 0.00015
    estimated_cost = (tokens / 1000) * cost_per_1k_input
    
    return tokens, estimated_cost

# Reject if too expensive
tokens, cost = estimate_cost(user_prompt)
if tokens > MAX_TOKENS_PER_REQUEST:
    raise HTTPException(400, "Prompt too long")
```

#### C. **Cache Common Responses**
```python
# Cache learning objectives by topic
OBJECTIVES_CACHE = {
    "linear_regression_undergraduate": [
        "Understand the mathematical foundation of linear regression",
        "Apply regression to real-world datasets",
        # ...
    ]
}

def generate_objectives(topic: str, level: str):
    cache_key = f"{topic.lower()}_{level.lower()}"
    
    if cache_key in OBJECTIVES_CACHE:
        return OBJECTIVES_CACHE[cache_key]  # FREE!
    
    # Otherwise call OpenAI
    return call_openai_for_objectives(topic, level)
```

#### D. **Batch Requests**
```python
# Instead of 3 separate API calls (planner, content, quiz)
# Make 1 call with structured output

prompt = f"""
Generate a complete lesson plan in JSON format:
{{
  "objectives": [...],
  "sections": [...],
  "resources": [...],
  "quiz": [...]
}}
Topic: {topic}
Level: {level}
"""

response = client.chat.completions.create(
    model="gpt-4o-mini",
    messages=[{"role": "user", "content": prompt}],
    response_format={"type": "json_object"}
)

# Parse once, use everywhere
lesson_data = json.loads(response.choices[0].message.content)
```

**Estimated Savings**: 30-50% reduction in OpenAI costs

---

## üéØ Phased Deployment Strategy

### **Phase 1: MVP (0-100 users)** - Months 1-3

**Goal**: Validate product-market fit with minimal cost

**Architecture**:
```yaml
Frontend: Vercel FREE tier
Backend: Railway.app ($5/mo)
Database: Supabase FREE tier
Storage: Cloudflare R2 (10GB free)
CDN: Cloudflare FREE
Email: Resend.com FREE tier (3k emails/mo)
Monitoring: Better Stack FREE + Sentry FREE
```

**Monthly Cost Breakdown**:
```
Railway:        $5
OpenAI API:     $50 (est. 100 lessons @ $0.50/lesson)
Domain:         $12/year = $1/mo
Total:          ~$56/month
```

**Scalability**: Can handle up to 500 users without upgrades

---

### **Phase 2: Growth (100-1000 users)** - Months 4-9

**Goal**: Scale infrastructure based on actual demand

**Architecture Changes**:
```yaml
Frontend: Vercel Pro ($20/mo) - Better analytics
Backend: Railway ($25/mo) - More resources
Database: Supabase Pro ($25/mo) - 8GB database
Storage: R2 (100GB = $1.50/mo)
Email: Resend Pro ($20/mo) - 50k emails/mo
Monitoring: Better Stack Standard ($10/mo)
```

**Monthly Cost Breakdown**:
```
Vercel Pro:        $20
Railway:           $25
Supabase Pro:      $25
R2 Storage:        $2
Email:             $20
Monitoring:        $10
OpenAI API:        $250 (est. 500 lessons/mo)
Total:             ~$352/month
```

**Revenue Required**: ~19 paid users ($19/mo plan) to break even

---

### **Phase 3: Scale (1000+ users)** - Month 10+

**Architecture Changes**:
```yaml
Frontend: Vercel Pro ($20/mo)
Backend: AWS ECS Fargate (2 containers @ $30/mo each)
Database: AWS RDS Reserved Instance (1-year, $300 upfront = $25/mo)
Cache: AWS ElastiCache t4g.micro ($12/mo)
Storage: Mix of R2 + S3 Glacier for archives
CDN: Cloudflare Pro ($20/mo)
Email: SendGrid ($50/mo)
Monitoring: DataDog ($15/host/mo)
```

**Monthly Cost Breakdown**:
```
Vercel:            $20
ECS Fargate:       $60
RDS (reserved):    $25
ElastiCache:       $12
Storage:           $10
CDN:               $20
Email:             $50
Monitoring:        $30
OpenAI API:        $500+ (variable)
Total:             ~$727/month + AI costs
```

---

## üí∞ Total Cost Comparison

| Phase | Users | Traditional AWS | Optimized Stack | Monthly Savings |
|-------|-------|----------------|-----------------|-----------------|
| **MVP** | 0-100 | $340 | $80 | **$260 (76%)** |
| **Growth** | 100-1000 | $1,155 | $350 | **$805 (70%)** |
| **Scale** | 1000+ | $2,500+ | $1,200 | **$1,300 (52%)** |

---

## üöÄ Quick Start: Railway Deployment

```bash
# 1. Install Railway CLI
npm install -g @railway/cli

# 2. Login and create project
railway login
railway init

# 3. Add PostgreSQL and Redis
railway add
# Select: PostgreSQL, Redis

# 4. Deploy
railway up

# 5. Set environment variables
railway variables set OPENAI_API_KEY=sk-xxx
railway variables set SUPABASE_URL=https://xxx.supabase.co
```

That's it! Railway auto-generates DATABASE_URL and REDIS_URL.

---

## üìã Cost Optimization Checklist

### Before Launch
- [ ] Use Cloudflare DNS + CDN (FREE)
- [ ] Deploy frontend on Vercel FREE tier
- [ ] Use Supabase FREE tier for database
- [ ] Implement Cloudflare R2 for storage (10GB free)
- [ ] Set up email with Resend.com FREE tier
- [ ] Configure Railway with auto-sleep after inactivity
- [ ] Enable gzip compression on API responses
- [ ] Implement Redis caching for hot paths
- [ ] Set OpenAI max_tokens limits
- [ ] Add cost tracking to all OpenAI calls

### After Launch
- [ ] Monitor cost daily for first week
- [ ] Set up billing alerts
- [ ] Analyze which features drive costs
- [ ] Implement usage quotas per tier
- [ ] Scale up only when near limits
- [ ] Review and optimize slow database queries
- [ ] Archive old files to reduce storage costs

---

## üéØ Key Recommendations

1. **Start with Railway + Supabase** - Easiest, cheapest path to production
2. **Use Cloudflare R2** instead of S3 - Save 70% on storage
3. **Deploy frontend on Vercel** - FREE for most use cases
4. **Implement aggressive caching** - Redis + Cloudflare = massive savings
5. **Monitor OpenAI costs** - Likely your biggest expense
6. **Scale gradually** - Don't over-provision "just in case"
7. **Use Reserved Instances** - Only when you hit consistent scale

**Bottom Line**: You can launch a production-grade SaaS for **under $100/month** and scale to 1,000 users for **under $400/month** with this architecture.

---

## üìû Next Steps

Would you like me to:
1. Set up the Railway + Supabase migration from your current SQLite?
2. Implement the cost tracking and monitoring system?
3. Create deployment scripts and CI/CD pipeline?
4. Build the comprehensive admin logging system you mentioned?

Let me know which area you'd like to tackle first!
